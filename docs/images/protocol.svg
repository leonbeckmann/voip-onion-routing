<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="937px" height="2771px" viewBox="-0.5 -0.5 937 2771" content="&lt;mxfile host=&quot;app.diagrams.net&quot; modified=&quot;2021-07-07T13:30:27.367Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.0.3 Safari/605.1.15&quot; etag=&quot;ygB1MJZAex4Zz1Hjzbj2&quot; version=&quot;14.8.4&quot; type=&quot;device&quot;&gt;&lt;diagram id=&quot;XSy51WEEWtVzyH33B7zv&quot; name=&quot;Page-1&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;" style="background-color: rgb(255, 255, 255);"><defs/><g><rect x="10" y="1250" width="900" height="1400" fill="#ffffff" stroke="#000000" pointer-events="all"/><rect x="10" y="160" width="580" height="1040" fill="#ffffff" stroke="#000000" pointer-events="all"/><path d="M 285 80 L 285 2683.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 285 2688.88 L 281.5 2681.88 L 285 2683.63 L 288.5 2681.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="200" y="90" width="175" height="50" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 173px; height: 1px; padding-top: 115px; margin-left: 201px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><span>&lt;PUB_ID_A, PRIV_ID_A&gt;,<br />PUB_ID_H,<br />PUB_ID_B<br /></span></div></div></div></foreignObject><text x="288" y="119" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">&lt;PUB_ID_A, PRIV_ID_A&gt;,...</text></switch></g><ellipse cx="847.5" cy="40" rx="60.00000000000001" ry="40" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 40px; margin-left: 789px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Bob</div></div></div></foreignObject><text x="848" y="44" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Bob</text></switch></g><ellipse cx="567.5" cy="40" rx="60.00000000000001" ry="40" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 40px; margin-left: 509px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Hop</div></div></div></foreignObject><text x="568" y="44" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Hop</text></switch></g><ellipse cx="285" cy="40" rx="60.00000000000001" ry="40" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 40px; margin-left: 226px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Alice</div></div></div></foreignObject><text x="285" y="44" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Alice</text></switch></g><rect x="480" y="90" width="175" height="50" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 173px; height: 1px; padding-top: 115px; margin-left: 481px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><span>&lt;PUB_ID_H, PRIV_ID_H&gt;,<br /></span></div></div></div></foreignObject><text x="568" y="119" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">&lt;PUB_ID_H, PRIV_ID_H&gt;,&#xa;</text></switch></g><rect x="760" y="90" width="175" height="50" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 173px; height: 1px; padding-top: 115px; margin-left: 761px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><span>&lt;PUB_ID_B, PRIV_ID_B&gt;,<br /></span></div></div></div></foreignObject><text x="848" y="119" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">&lt;PUB_ID_B, PRIV_ID_B&gt;,&#xa;</text></switch></g><rect x="0" y="150" width="260" height="120" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 258px; height: 1px; padding-top: 158px; margin-left: 2px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Choose Elliptic Curve <b>E, </b>Generator <b>G</b>, and private ECDHE parameter <b>a<sub>1</sub></b></li></ul><ul><li>Calculate public ECDHE parameter <b>a<sub>1</sub>G</b></li></ul></div></div></div></foreignObject><text x="2" y="170" fill="#000000" font-family="Helvetica" font-size="12px">Choose Elliptic Curve E, Generator G, and p...</text></switch></g><path d="M 570 280 L 570 2683.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 570 2688.88 L 566.5 2681.88 L 570 2683.63 L 573.5 2681.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 270.5 286 L 270.5 276 L 550.5 276 L 550.5 265.5 L 569.5 281 L 550.5 296.5 L 550.5 286 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 271px; margin-left: 411px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-weight: bold; background-color: #ffffff; white-space: nowrap; ">Client_Hello = {E, G, a<sub>1</sub>G}</div></div></div></foreignObject><text x="411" y="274" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle" font-weight="bold">Client_Hello = {E, G, a1G}</text></switch></g><rect x="340" y="280" width="220" height="330" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 218px; height: 1px; padding-top: 288px; margin-left: 342px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Choose a private ECDHE parameter <b>h<sub>1</sub> </b>and calculate the public parameter <b>h<sub>1</sub>G</b></li></ul><ul><li>Calculate the shared secret <b>s<sub>AH</sub> = h<sub>1</sub>a<sub>1</sub>G</b></li></ul><ul><li>Derive shared keys via KDF and <b>s<sub>AH</sub></b>: <b>K_ENC<sub>AH</sub>, K_ENC<sub>HA</sub>, </b><b>K_MAC<sub>AH</sub>, K_MAC<sub>HA</sub></b></li></ul><ul><li>Create fresh challenge <b>c</b></li></ul><ul><li>Create signature of all values using the private identity key<b> sig<sub>1</sub> = sign<sub>RSA</sub>(PRIV_ID_H, sha256({h<sub>1</sub>G, c, E, G, a<sub>1</sub>G}))</b></li></ul><ul><li>Encrypt the signature <b>sig<sub>1_enc</sub> = enc(K_ENC<sub>HA</sub>, sig<sub>1</sub>)</b><br /></li></ul><div><font size="1"><b><br /></b></font></div></div></div></div></foreignObject><text x="342" y="300" fill="#000000" font-family="Helvetica" font-size="12px">Choose a private ECDHE parameter h1...</text></switch></g><path d="M 569.5 635 L 569.5 645 L 289.5 645 L 289.5 655.5 L 270.5 640 L 289.5 624.5 L 289.5 635 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 631px; margin-left: 410px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-weight: bold; background-color: #ffffff; white-space: nowrap; ">Server_Hello = {h<sub>1</sub>G, c, sig<sub>1_enc</sub>}</div></div></div></foreignObject><text x="410" y="634" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle" font-weight="bold">Server_Hello = {h1G, c, sig1_enc}</text></switch></g><rect x="0" y="660" width="280" height="360" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 278px; height: 1px; padding-top: 668px; margin-left: 2px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Calculate the shared secret <b>s<sub>AH</sub> = a<sub>1</sub></b><b>h<sub>1</sub>G</b></li></ul><ul><li>Derive shared keys via KDF and <b>s<sub>AH</sub></b>: <b>K_ENC<sub>AH</sub>, K_ENC<sub>HA</sub>, </b><b>K_MAC<sub>AH</sub>, K_MAC<sub>HA</sub></b></li></ul><ul><li>Decrypt signature<b> sig<sub>1</sub> = dec(K_ENC<sub>HA</sub>, sig<sub>1_enc</sub>)</b></li></ul><ul><li>Verify signature using the public identity key of H: <b>verify<sub>RSA</sub>(sig<sub>1</sub>, PUB_ID_H, sha256({h<sub>1</sub>G, c, E, G, a<sub>1</sub>G}))</b></li></ul><ul><li>create <b>m = Routing {next_hop = Bob}</b></li></ul><ul><li>Encrypt routing information: <b>m<sub>enc</sub> = enc(K_ENC<sub>AH,</sub> m)</b></li></ul><ul><li>Create a MAC: <b>m<sub>mac</sub> = hmac(K_MAC<sub>AH</sub>, m_enc)</b></li></ul></div></div></div></foreignObject><text x="2" y="680" fill="#000000" font-family="Helvetica" font-size="12px">Calculate the shared secret sAH = a1h1G...</text></switch></g><path d="M 270.5 995 L 270.5 985 L 550.5 985 L 550.5 974.5 L 569.5 990 L 550.5 1005.5 L 550.5 995 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 981px; margin-left: 420px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-weight: bold; background-color: #ffffff; white-space: nowrap; ">RoutingInformation = {m<sub>enc</sub>, m<sub>mac</sub>}</div></div></div></foreignObject><text x="420" y="984" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle" font-weight="bold">RoutingInformation = {menc, mmac}</text></switch></g><rect x="340" y="1000" width="220" height="170" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 218px; height: 1px; padding-top: 1008px; margin-left: 342px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Verify MAC: <b>verify<sub>HMAC</sub>(K_MAC<sub>AH</sub>, m<sub>enc</sub>)</b></li></ul><ul><li>Decrypt routing information:<b> m = dec(K_ENC<sub>AH</sub>, m<sub>enc</sub>)</b></li></ul><ul><li>Store NEXT_HOP = m.next_hop and mark this peer as intermediate hop</li></ul><div><font size="1"><b><br /></b></font></div></div></div></div></foreignObject><text x="342" y="1020" fill="#000000" font-family="Helvetica" font-size="12px">Verify MAC: verifyHMAC(K_MACAH, menc...</text></switch></g><path d="M 270.5 1366 L 270.5 1356 L 550.5 1356 L 550.5 1345.5 L 569.5 1361 L 550.5 1376.5 L 550.5 1366 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 1351px; margin-left: 411px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-weight: bold; background-color: #ffffff; white-space: nowrap; ">data</div></div></div></foreignObject><text x="411" y="1354" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle" font-weight="bold">data</text></switch></g><rect x="340" y="1360" width="220" height="60" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 218px; height: 1px; padding-top: 1368px; margin-left: 342px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Decrypt message: <b>ClientHello = dec(K_ENC<sub>AH</sub>, data)</b></li></ul><div><font size="1"><b><br /></b></font></div></div></div></div></foreignObject><text x="342" y="1380" fill="#000000" font-family="Helvetica" font-size="12px">Decrypt message: ClientHello = dec(K...</text></switch></g><path d="M 849.5 1815 L 849.5 1825 L 589.5 1825 L 589.5 1835.5 L 570.5 1820 L 589.5 1804.5 L 589.5 1815 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 1811px; margin-left: 701px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-weight: bold; background-color: #ffffff; white-space: nowrap; ">Server_Hello = {bG, c, sig<sub>2_enc</sub>}</div></div></div></foreignObject><text x="701" y="1814" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle" font-weight="bold">Server_Hello = {bG, c, sig2_enc}</text></switch></g><rect x="0" y="1910" width="280" height="470" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 278px; height: 1px; padding-top: 1918px; margin-left: 2px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Decrypt the Server_Hello:<span>	<span>	<span>	</span></span></span><b> {bG, c, sig_<sub>2_enc</sub>} = dec(K_ENC<sub>HA</sub>, m)</b></li></ul><ul><li>Calculate the shared secret <b>s<sub>AB</sub> = a<sub>2 * </sub>bG</b></li></ul><ul><li>Derive shared keys via KDF and <b>s<sub>AB</sub></b>: <b>K_ENC<sub>AB</sub>, K_ENC<sub>BA</sub>, </b><b>K_MAC<sub>AB</sub>, K_MAC<sub>BA</sub></b></li></ul><ul><li>Decrypt signature<b> sig<sub>2</sub> = dec(K_ENC<sub>BA</sub>, sig<sub>2_enc</sub>)</b></li></ul><ul><li>Verify signature using the public identity key of B: <b>verify<sub>RSA</sub>(sig<sub>2</sub>, PUB_ID_B, sha256({bG, c, E, G, a<sub>2</sub>G}))</b></li></ul><ul><li>Solve the challenge: <b>r = sign<sub>RSA</sub>(PRIV_ID_A, sha256(c))</b></li></ul><ul><li>create <b>m = Routing {next_hop = none, r, PUB_ID_A}</b></li></ul><ul><li>Encrypt routing information: <b>m<sub>enc</sub> = enc(K_ENC_AB, m)</b></li></ul><ul><li>Create a MAC: <b>m<sub>mac</sub> = hmac(K_MAC_AB, m_enc)</b></li></ul><ul><li>Tunnel data via H: <b>data = enc(K_ENC<sub>AH</sub>, {m<sub>enc, </sub>m<sub>mac</sub>)</b></li></ul></div></div></div></foreignObject><text x="2" y="1930" fill="#000000" font-family="Helvetica" font-size="12px">Decrypt the Server_Hello:			 {bG, c, sig_2_enc...</text></switch></g><path d="M 280.5 2375 L 280.5 2365 L 550.5 2365 L 550.5 2354.5 L 569.5 2370 L 550.5 2385.5 L 550.5 2375 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 2361px; margin-left: 425px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-weight: bold; background-color: #ffffff; white-space: nowrap; ">data</div></div></div></foreignObject><text x="425" y="2364" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle" font-weight="bold">data</text></switch></g><rect x="590" y="2430" width="250" height="170" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 248px; height: 1px; padding-top: 2438px; margin-left: 592px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Verify MAC: <b>verify<sub>HMAC</sub>(K_MAC_AB, m<sub>enc</sub>)</b></li></ul><ul><li>Decrypt routing information:<b> {next_hop = none, r, PUB_ID_A} = dec(K_ENC_AB, m<sub>enc</sub>)</b></li></ul><ul><li>Verify challenge-Response: <b>verify<sub>RSA</sub>(r, PUB_ID_A, sha256(c))</b></li></ul><ul><li>mark peer as target</li></ul><div><font size="1"><b><br /></b></font></div></div></div></div></foreignObject><text x="592" y="2450" fill="#000000" font-family="Helvetica" font-size="12px">Verify MAC: verifyHMAC(K_MAC_AB, menc)...</text></switch></g><path d="M 846.79 1460 L 847 2683.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 847 2688.88 L 843.5 2681.88 L 847 2683.63 L 850.5 2681.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="0" y="1240" width="260" height="120" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 258px; height: 1px; padding-top: 1248px; margin-left: 2px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Choose a private ECDHE parameter <b>a<font size="1"><sub>2</sub></font></b></li></ul><ul><li>Calculate public ECDHE parameter <b>a<font size="1"><sub>2</sub></font></b><b>G</b></li></ul><ul><li>Tunnel ClientHello = {E, G, a<sub>2</sub>G} via H: <b>data = enc(K_ENC<sub>AH</sub>, {E, G, a<sub>2</sub>G})</b><br /></li></ul></div></div></div></foreignObject><text x="2" y="1260" fill="#000000" font-family="Helvetica" font-size="12px">Choose a private ECDHE parameter a2...</text></switch></g><path d="M 570.5 1465 L 570.5 1455 L 830.5 1455 L 830.5 1444.5 L 849.5 1460 L 830.5 1475.5 L 830.5 1465 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 1450px; margin-left: 700px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-weight: bold; background-color: #ffffff; white-space: nowrap; ">Client_Hello = {E, G, a<sub>2</sub>G} </div></div></div></foreignObject><text x="700" y="1453" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle" font-weight="bold">Client_Hello = {E, G, a2G} </text></switch></g><rect x="620" y="1470" width="220" height="330" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 218px; height: 1px; padding-top: 1478px; margin-left: 622px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Choose a private ECDHE parameter <b>b </b>and calculate the public parameter <b>bG</b></li></ul><ul><li>Calculate the shared secret <b>s<sub>AB</sub> = b*a<sub>1</sub>G</b></li></ul><ul><li>Derive shared keys via KDF and <b>s<sub>AB</sub></b>: <b>K_ENC<sub>AB</sub>, K_ENC<sub>BA</sub>, </b><b>K_MAC<sub>AB</sub>, K_MAC<sub>BA</sub></b></li></ul><ul><li>Create fresh challenge <b>c</b></li></ul><ul><li>Create signature of all values using the private identity key<b> sig<sub>2</sub> = sign<sub>RSA</sub>(PRIV_ID_B, sha256({bG, c, E, G, a<sub>2</sub>G}))</b></li></ul><ul><li>Encrypt the signature <b>sig<sub>2_enc</sub> = enc(K_ENC<sub>BA</sub>, sig<sub>2</sub>)</b><br /></li></ul><div><font size="1"><b><br /></b></font></div></div></div></div></foreignObject><text x="622" y="1490" fill="#000000" font-family="Helvetica" font-size="12px">Choose a private ECDHE parameter b a...</text></switch></g><rect x="340" y="1820" width="240" height="60" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 238px; height: 1px; padding-top: 1828px; margin-left: 342px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Encrypt ServerHello:<b> m = enc(K_ENC<sub>HA</sub>, <span style="font-size: 11px ; text-align: center ; background-color: rgb(255 , 255 , 255)"> {bG, c, sig</span><sub style="text-align: center ; background-color: rgb(255 , 255 , 255)">2_enc</sub><span style="font-size: 11px ; text-align: center ; background-color: rgb(255 , 255 , 255)">}</span>)</b></li></ul><div><font size="1"><b><br /></b></font></div></div></div></div></foreignObject><text x="342" y="1840" fill="#000000" font-family="Helvetica" font-size="12px">Encrypt ServerHello: m = enc(K_ENCHA,  {...</text></switch></g><path d="M 569.5 1885 L 569.5 1895 L 302.5 1895 L 302.5 1905.5 L 283.5 1890 L 302.5 1874.5 L 302.5 1885 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 1881px; margin-left: 419px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-weight: bold; background-color: #ffffff; white-space: nowrap; ">m</div></div></div></foreignObject><text x="419" y="1884" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle" font-weight="bold">m</text></switch></g><rect x="340" y="2380" width="220" height="60" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 218px; height: 1px; padding-top: 2388px; margin-left: 342px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><ul><li>Decrypt message: <b>{m<sub>enc</sub>, m<sub>mac</sub>} = dec(K_ENC<sub>AH</sub>, data)</b></li></ul><div><font size="1"><b><br /></b></font></div></div></div></div></foreignObject><text x="342" y="2400" fill="#000000" font-family="Helvetica" font-size="12px">Decrypt message: {menc, mmac} = dec(...</text></switch></g><path d="M 570.5 2425 L 570.5 2415 L 830.5 2415 L 830.5 2404.5 L 849.5 2420 L 830.5 2435.5 L 830.5 2425 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 2411px; margin-left: 709px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 11px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; font-weight: bold; background-color: #ffffff; white-space: nowrap; "><span style="font-size: 12px ; text-align: left ; background-color: rgb(248 , 249 , 250)">RoutingInformation =  </span><span style="font-size: 12px ; text-align: left">{m<sub>enc</sub>, m<sub>mac</sub>}</span></div></div></div></foreignObject><text x="709" y="2414" fill="#000000" font-family="Helvetica" font-size="11px" text-anchor="middle" font-weight="bold">RoutingInformation =  {menc, mmac}</text></switch></g><rect x="10" y="2710" width="900" height="60" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 898px; height: 1px; padding-top: 2740px; margin-left: 11px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">APPLICATION DATA between Alice and Bob</div></div></div></foreignObject><text x="460" y="2744" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">APPLICATION DATA between Alice and Bob</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Viewer does not support full SVG 1.1</text></a></switch></svg>